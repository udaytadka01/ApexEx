name: Deploy

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged

    steps:
      - name: checkout
        if: github.event.pull_request.merged
        uses: actions/checkout@v1

    
  deploy:      
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: deploy to prod
      run: echo deployment complete
      
    - name: Install Salesforce CLI
      run: |
       wget https://developer.salesforce.com/media/salesforce-cli/sfdx-cli/channels/stable/sfdx-cli-v7.72.0-697e9faee2-linux-x64.tar.xz
       mkdir sfdx-cli
       tar xJf sfdx-cli-v7.72.0-697e9faee2-linux-x64.tar.xz -C sfdx-cli --strip-components 1
       ./sfdx-cli/install
     
    - name: Authenticate Sandbox
      run: |
        echo "${SALESFORCE_JWT_SECRET_KEY}" > server.key
        sfdx force:auth:jwt:grant --jwtkeyfile ./server.key --setalias EPAM --instanceurl https://test.salesforce.com --clientid $(cat ./main/EPAM_CONSUMER_KEY) --username $(cat ./main/EPAM_USERNAME)
      env:
        SALESFORCE_JWT_SECRET_KEY: ${{ secrets.SALESFORCE_JWT_SECRET_KEY }}
    - name: Deploy code to Target Sandbox
      run: |
          cd ./main
          sfdx force:source:deploy --wait 180 -u EPAM --manifest manifest/package.xml --verbose

